# マルチテナント・サブスクリプション・会員制の違いまとめ

## 3つの概念の基本定義

### 🏢 マルチテナント
**システムアーキテクチャの設計パターン**
- 1つのシステムインスタンスを複数の顧客（テナント）が共有
- 各テナントのデータは論理的に分離
- 「どうシステムを設計するか？」に答える

### 💳 サブスクリプション
**ビジネスモデル・課金方式**
- 定期的な料金支払いでサービスを提供
- 月額・年額などの継続課金
- 「どう課金するか？」に答える

### 🔐 会員制サイト
**アクセス制御の仕組み**
- 登録・認証したユーザーのみアクセス可能
- ログインが必要なサイト
- 「誰がアクセスできるか？」に答える

## 組み合わせパターンと実例

| サービス例 | 会員制 | サブスク | マルチテナント | 説明 |
|---------|--------|----------|---------------|------|
| Netflix | ✅ | ✅ | ✅ | 会員登録必須、月額課金、1システムを全ユーザーで共有 |
| 無料フォーラム | ✅ | ❌ | - | 登録必要だが無料 |
| Googleドキュメント（無料版） | ✅ | ❌ | ✅ | 無料だがマルチテナント |
| 個人のWordPress有料ブログ | ✅ | ✅ | ❌ | 自分専用のシステム |
| note（クリエイター視点） | ✅ | ✅ | ✅ | 多数のクリエイターが1つのシステムを共有 |

## 具体的なケーススタディ

### ケース1：個人の有料記事配信（Stripe決済）
```
構成：
- 会員制 ✅ （ログイン必要）
- サブスクリプション ✅ （定期課金）
- マルチテナント ❌ （コンテンツ提供者は1人）
```
**ポイント**：読者は「ユーザー」であって「テナント」ではない

### ケース2：教育コンテンツLMS（進捗管理付き）
```
構成：
- 会員制 ✅ （ユーザー登録必要）
- サブスクリプション ✅ （プラン別課金）
- マルチテナント ❌ （教育者は1人）
```
**ポイント**：機能の充実度とマルチテナントは無関係

### ケース3：法人向け一括決済対応
```
必要なのは：
- マルチテナント化 ❌
- 法人向けプラン機能 ✅
```
**実装内容**：
- 組織単位の一括決済
- メンバーのシート管理
- 管理者によるメンバー追加・削除

## マルチテナントになる条件

### シングルテナントの構造
```
あなたのサービス
├── ユーザーA
├── ユーザーB
└── ユーザーC
```

### マルチテナントの構造
```
プラットフォーム
├── 事業者A（テナント）
│   └── Aの顧客たち
├── 事業者B（テナント）
│   └── Bの顧客たち
└── 事業者C（テナント）
    └── Cの顧客たち
```

## 法人向けプラン機能の詳細

### 法人一括決済とマルチテナントの根本的な違い

#### マルチテナントアーキテクチャ
```
システム
├── A社（独立した環境）
│   ├── A社専用の設定・カスタマイズ
│   ├── A社のデータ（他社からは完全に隔離）
│   └── A社の社員たち
├── B社（独立した環境）
│   ├── B社専用の設定・カスタマイズ
│   ├── B社のデータ（他社からは完全に隔離）
│   └── B社の社員たち
└── C社（独立した環境）
    ├── C社専用の設定・カスタマイズ
    ├── C社のデータ（他社からは完全に隔離）
    └── C社の社員たち
```

**特徴**：
- 各企業が独立した「テナント」として存在
- データの完全な論理的分離
- 企業ごとのカスタマイズが可能
- 複雑なアーキテクチャ設計が必要

#### シングルテナント＋法人プラン
```
あなたのLMS
├── 個人ユーザーA（個人プラン）
├── 個人ユーザーB（個人プラン）
├── X社チーム（法人プラン・一括決済）
│   ├── 管理者（請求先・メンバー管理）
│   ├── 社員1（X社のライセンスで利用）
│   ├── 社員2（X社のライセンスで利用）
│   └── 社員3（X社のライセンスで利用）
└── Y社チーム（法人プラン・一括決済）
    ├── 管理者（請求先・メンバー管理）
    ├── 社員1（Y社のライセンスで利用）
    └── 社員2（Y社のライセンスで利用）
```

**特徴**：
- すべてのユーザーが同じシステムを利用
- 法人は「グループ化された複数ユーザー」として扱う
- 決済と権限管理の仕組みだけを法人対応
- シンプルな実装で済む

### Stripeを使った法人プラン実装の具体例

#### 1. データモデル設計
```javascript
// 組織（Organization）
{
  id: "org_xxx",
  name: "株式会社X",
  stripe_customer_id: "cus_xxx",
  subscription_id: "sub_xxx",
  seats: 10,  // 契約シート数
  billing_email: "billing@company.com"
}

// ユーザー（User）
{
  id: "user_xxx",
  email: "employee@company.com",
  organization_id: "org_xxx",  // 所属組織
  role: "member",  // member | admin
  is_individual: false  // 個人契約か組織契約か
}
```

#### 2. Stripe実装パターン
```javascript
// 組織の作成と subscription 設定
const customer = await stripe.customers.create({
  email: 'billing@company.com',
  name: '株式会社X',
  metadata: {
    organization_id: 'org_xxx'
  }
});

const subscription = await stripe.subscriptions.create({
  customer: customer.id,
  items: [{
    price: 'price_xxx',  // シート単価のプライスID
    quantity: 10  // 初期シート数
  }],
  payment_behavior: 'default_incomplete',
  expand: ['latest_invoice.payment_intent']
});

// シート数の変更（メンバー追加時）
await stripe.subscriptionItems.update(
  'si_xxx',
  {quantity: 12}  // 10→12シートに増加
);
```

#### 3. 必要な管理機能

**組織管理者向けダッシュボード**
- メンバー一覧表示と招待機能
- メンバーの削除（シート解放）
- 使用中シート数 / 契約シート数の表示
- 請求履歴の確認
- 支払い方法の変更

**メンバー招待フロー**
```
1. 管理者が招待メールを送信
2. 招待URLからサインアップ
3. 組織に自動的に紐付け
4. シート数を自動でカウントアップ
5. 上限超過時は警告 or 自動追加（設定による）
```

### 実装上の重要な考慮点

#### 料金体系の選択肢
1. **固定シート数プラン**
   - 5名プラン、10名プラン、20名プランなど
   - プラン変更時に差額精算

2. **従量課金（Pay-as-you-go）**
   - 実際の利用人数×単価
   - 月末に自動精算

3. **階段型料金**
   - 1-5名: ¥1,000/人
   - 6-20名: ¥900/人
   - 21名以上: ¥800/人

#### 権限管理の階層
```
組織オーナー
├── 支払い情報の管理
├── 組織の削除
└── 管理者の任命

組織管理者
├── メンバーの招待・削除
├── 利用状況の確認
└── 基本設定の変更

一般メンバー
└── コンテンツの利用のみ
```

### 参考実装：主要サービスの法人プラン

| サービス | 決済方式 | シート管理 | 特徴 |
|---------|----------|------------|------|
| **Slack** | 年額/月額一括 | 自動カウント | アクティブユーザーのみ課金 |
| **Notion** | 年額/月額一括 | 固定シート | 未使用シートも課金 |
| **GitHub** | 年額/月額一括 | 固定シート | Organization単位で権限管理 |
| **Zoom** | 年額/月額一括 | ライセンス制 | ホスト権限のみ有料 |
| **ChatGPT Team** | 年額/月額一括 | 最小2シート | シート単位で追加可能 |

## 重要な理解ポイント

1. **これらは独立した概念**
   - それぞれ異なる問題を解決する
   - 自由に組み合わせ可能

2. **マルチテナントの判断基準**
   - 複数の独立した事業者がシステムを共有 → マルチテナント
   - 1人の事業者と複数のユーザー → シングルテナント

3. **法人対応≠マルチテナント**
   - 法人向け機能は決済・管理の仕組み
   - マルチテナントは根本的なアーキテクチャ
   - **法人プランはシングルテナントでも実装可能**

4. **実装の複雑さ**
   - 会員制：簡単（認証機能の追加）
   - サブスクリプション：中程度（決済システム連携）
   - 法人プラン：中程度（グループ管理・権限設定）
   - マルチテナント：複雑（データ分離、セキュリティ設計）

## 法人向け機能の拡張とマルチテナントの境界線

### よくある法人向け追加要望

#### 「管理者が各メンバーの進捗を見たい」
これは**組織内の可視化・レポーティング機能**の話です。

**実装内容**：
```javascript
// 学習進捗データ
{
  user_id: "user_xxx",
  course_id: "course_xxx",
  organization_id: "org_xxx",
  completed_lessons: ["lesson_1", "lesson_2"],
  completion_rate: 45,
  last_accessed: "2025-08-22",
  total_study_time: 3600
}
```

**管理者ダッシュボードの拡張**：
```
組織管理者の画面
├── メンバー管理
├── 請求管理
└── 📊 学習レポート（追加）
    ├── メンバー別進捗一覧
    ├── コース別完了率
    ├── 学習時間ランキング
    ├── 個人別詳細レポート
    └── CSVエクスポート
```

### これでもシングルテナントである理由

**高機能な法人対応LMSの構造**：
```
あなたのLMS
├── 個人ユーザー
├── A社チーム
│   ├── 管理者（全員の進捗閲覧可）
│   ├── 営業部
│   │   ├── リーダー（営業部の進捗閲覧可）
│   │   └── メンバー達
│   └── 開発部
│       ├── リーダー（開発部の進捗閲覧可）
│       └── メンバー達
└── B社チーム
    └── （同様の構造）
```

**なぜシングルテナントか**：
- コンテンツ提供者（テナント）は**あなた1人**
- 各企業は「ユーザーのグループ」に過ぎない
- 各企業が独自のコースを作成・販売するわけではない

### マルチテナント化の境界線

#### シングルテナントの範囲内（法人向け機能）
以下の要望はすべて**シングルテナント＋法人プラン**で対応可能：
- ✅ 管理者によるメンバーの進捗確認
- ✅ 部署別のコース割り当て
- ✅ 必須コースの設定
- ✅ 修了証の発行
- ✅ 組織別のレポート生成
- ✅ カスタム研修パスの作成

#### マルチテナント化が必要になる瞬間
**「A社が自社の教育コンテンツを作って、自社の顧客に販売したい」**

この要望が来た時、初めて本当のマルチテナント化を検討する必要があります：

```
マルチテナントLMSプラットフォーム
├── あなた（テナント1）
│   ├── あなたのコンテンツ
│   └── あなたの顧客（個人・法人）
├── A社（テナント2）
│   ├── A社のコンテンツ
│   └── A社の顧客
└── B社（テナント3）
    ├── B社のコンテンツ
    └── B社の顧客
```

### 重要な判断基準

**「管理者がメンバーの進捗を見たい」は**：
- **よくある要望で、実装すべき機能** ✅
- **法人プランの価値を高める重要な要素** ✅
- **でも、これを実装してもマルチテナントにはならない** ⚠️

**真のマルチテナント化が必要になるのは**：
- 複数の組織が**独自のコンテンツを作成・管理**したい
- 各組織が**自社の顧客に対して販売**したい
- プラットフォームビジネスへの転換を検討する時

この境界線を理解することで、過剰な設計を避けつつ、適切な機能実装ができます。