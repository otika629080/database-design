# DB設計

## 会員のテーブル設計
```sql
CREATE TABLE 会員
(
    会員ID   INT PRIMARY KEY,
    会員種別 VARCHAR(50) NOT NULL
);

-- 有効期限によっては1会員に複数のカードが発行されるかもしれないので「会員:会員カード = 一対多」のリレーション
CREATE TABLE 会員カード
(
    会員カードID INT PRIMARY KEY,
    会員ID       INT NOT NULL,
    発行日       DATE        NOT NULL,
    有効期限     DATE        NOT NULL,
    ステータス   VARCHAR(50) NOT NULL,
    FOREIGN KEY (会員ID) REFERENCES 会員 (会員ID)
);

CREATE TABLE 個人会員
(
    会員ID         INT PRIMARY KEY,
    氏名           VARCHAR(50)  NOT NULL,
    生年月日       DATE         NOT NULL,
    住所           VARCHAR(200) NOT NULL,
    電話番号       VARCHAR(12)  NOT NULL,
    メールアドレス VARCHAR(50)  NOT NULL,
    FOREIGN KEY (会員ID) REFERENCES 会員 (会員ID)
);

CREATE TABLE 団体会員
(
    会員ID               INT PRIMARY KEY,
    団体名               VARCHAR(50)  NOT NULL,
    団体種別             VARCHAR(50)  NOT NULL,
    団体電話番号         VARCHAR(12)  NOT NULL,
    団体住所             VARCHAR(200) NOT NULL,
    団体メールアドレス   VARCHAR(50)  NOT NULL,
    代表者氏名           VARCHAR(50)  NOT NULL,
    代表者電話番号       VARCHAR(12)  NOT NULL,
    代表者メールアドレス VARCHAR(50)  NOT NULL,
    FOREIGN KEY (会員ID) REFERENCES 会員 (会員ID)
);
```

## 書誌のテーブル設計
```sql
CREATE TABLE 書誌
(
    書誌ID            VARCHAR(12) PRIMARY KEY,
    タイトル          VARCHAR(400) NOT NULL,
    タイトルよみ      VARCHAR(400) NOT NULL,
    シリーズタイトル  VARCHAR(300) NOT NULL,
    責任表示          VARCHAR(400) NOT NULL,
    出版者            VARCHAR(300) NOT NULL,
    出版地            VARCHAR(10)  NOT NULL,
    出版年月日等      VARCHAR(40)  NOT NULL,
    出版年            VARCHAR(10)  NOT NULL,
    分類_NDC          VARCHAR(60)  NOT NULL,
    分類_NDLC         VARCHAR(128) NOT NULL,
    件名標目          VARCHAR(200) NOT NULL,
    ジャンル_形式用語 VARCHAR(100) NOT NULL,
    請求記号          VARCHAR(50)  NOT NULL,
    ISBN              VARCHAR(512) NOT NULL
);

CREATE TABLE 蔵書
(
    蔵書ID     INT PRIMARY KEY,
    書誌ID     VARCHAR(12) NOT NULL,
    ステータス VARCHAR(50) NOT NULL,
    保管場所   VARCHAR(100) NOT NULL,
    FOREIGN KEY (書誌ID) REFERENCES 書誌 (書誌ID)
);
```

## ウォームアップ課題Lv1
書誌テーブルからタイトルに「プログラミング」を含むレコードを取得しよう
```sql
SELECT *
FROM 書誌
WHERE タイトル LIKE '%プログラミング%';
```

## ウォームアップ課題Lv2
有効期限切れの会員カードを持つ個人会員の会員IDと氏名、メールアドレスを取得しよう
- INNER JOINはキーが一致するレコードが残る
- LEFT(OUTER) JOINはキーが一致しなくても左側のレコードは全て残る
```sql
-- CURDATE()はMySQLの関数で現在の日付を表す
SELECT 個人会員.会員ID, 氏名, メールアドレス
FROM 会員カード
INNER JOIN 個人会員 ON 個人会員.会員ID = 会員カード.会員ID
WHERE 有効期限 < CURDATE();
```

## ウォームアップ課題Lv3
蔵書数ごとの書誌数の合計を取得しよう
- 書誌ごとの蔵書数 = ステップアップMySQLが4冊
- 蔵書数ごとの書誌数 = 同じ本がN冊ある書誌の合計。蔵書4冊の書式数:X冊, ...
- サブクエリ: 結果をテーブルであるかのように扱える
```sql
-- WITH句は事前にサブクエリを定義できる
WITH 書誌別冊数 AS (
    SELECT 書誌ID, COUNT(*) AS 合計冊数
    FROM 蔵書
    WHERE ステータス != '処分'
    GROUP BY 書誌ID
)

-- COALESCE関数は合計冊数がNULLだった時に0に置き換える
SELECT COALESCE(合計冊数, 0) AS 合計冊数,
COUNT(*) AS 書誌数
FROM 書誌
LEFT JOIN 書誌別冊数 USING (書誌ID)
GROUP BY 合計冊数
ORDER BY 合計冊数;
```
