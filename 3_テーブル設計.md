# この章で学ぶこと
- データベース設計の基本的な考え方を理解する
- イベント型設計とステート型設計の違い
- ロングタームイベントパターンの活用方法
- 状態管理の3つの設計パターン
- 実際の業務要件をテーブル設計に落とし込む方法

## テーブル設計で意識する2つの観点
- 起こった事実(イベント)の記録: INSERT
- 現在の状態(ステート): UPDATE or (DELETE & INSERT)

### 具体例1
予約申込、キャンセル、予約取り置きは事実のイベント。

予約は現在の状態。予約中、取り置き中は現在の特定の状態。

予約
- 予約ID
- 予約ステータス

予約イベント
- 予約イベントID

予約申込中
- 予約ID
- 会員ID
- 書誌ID
- 予約開始日

取り置き中
- 予約ID
- 会員ID
- 蔵書ID
- 取り置き開始日
- 取り置き期限

予約申込
- 予約イベントID
- 会員ID
- 書誌ID
- 予約開始日

予約キャンセル
- 予約イベントID

予約取り置き
- 予約イベントID
- 取り置きID
- 取り置き開始日
- 取り置き期限

### 具体例2
個人会員変更は変更履歴のイベント

個人会員は現在の状態

会員
- 会員ID
- 会員種別

個人会員
- 会員ID
- 氏名
- 生年月日
- 電話番号
- メールアドレス
- 住所

個人会員変更
- 個人会員変更
- 会員ID
- 氏名
- 生年月日
- 電話番号
- メールアドレス
- 住所

### イベントの性質
- ある時点の状態を復元可能(監査、履歴)
- 業務をより正確にテーブル設計に反映(業務の見える化、見積もり精度UP)

### よくないテーブル設計例
会員
- 会員ID
- 会員ステータス
- 氏名
- 生年月日
- 電話番号
- メールアドレス
- 住所
- 申請ステータス
- 利用申請日
- 利用目的
- 証明書保存先
- 申請承認時刻
- 申請承認管理者ID
- 申請否認時刻
- 申請否認管理者ID
- 会員カード受領フラグ
- 会員カード発行日
- 会員カード有効期限
- 団体名
- 団体概要
- 団体電話番号
- 団体メールアドレス
- 団体住所


どういう状態でどのカラムが更新される？

利用申請中でも会員IDが発行される

利用中の会員であることを判断するには？

### イベントを整理したテーブル設計例
イベントはINSERT、状態はUPDATE

業務上発生するイベントを時系列で表現

利用申請
- 利用申請ID
- 会員種別
- 利用申請ステータス

利用申請イベント
- 利用申請アクティビティID
- 利用申請ID

利用申請提出
- 利用申請イベントID
- 利用申請ID

利用申請承認
- 利用申請イベントID
- 利用申込ID
- 承認管理者ID

利用申請否認
- 利用申請イベントID
- 利用申込ID
- 否認管理者ID
- 否認理由

利用開始
- 利用申請イベントID
- 利用申請ID
- 会員ID
- 担当管理者ID

個人利用申請提出
- 利用申請イベントID
- 利用申請ID
- 氏名
- 生年月日
- 電話番号
- メールアドレス
- 住所
- 利用目的
- 証明書保存先

団体利用申請提出
- 利用申請イベントID
- 利用申請ID
- 団体名
- 団体概要
- 団体電話番号
- 団体メールアドレス
- 団体住所
- 代表者氏名
- 代表者　住所
- 代表者　電話番号
- 代表者　メールアドレス
- 利用目的
- 証明書保存先

会員
- 会員ID
- 会員種別

会員カード
- 会員ID
- 発行日
- 有効期限
- ステータス

個人会員
- 会員ID
- 氏名
- 生年月日
- 電話番号
- メールアドレス
- 住所

団体会員
- 会員ID
- 団体名
- 団体概要
- 団体電話番号
- 団体メールアドレス
- 団体住所
- 代表者　氏名
- 代表者　住所
- 代表者　電話番号
- 代表者　メールアドレス

### イベントを表現できてないクラス実装例
ありえない状態のバリデーションを実装せざるを得ない
```kotlin
class 予約(
    val 予約ステータス: ReservationStatus,
    val 予約ID: String,
    val 会員ID: String,
    val 書誌ID: String,
    val 予約開始日: String,
    val キャンセル日: LocalDate?,
    val 取置きID: String,
    val 取置き開始日: LocalDate?,
    val 取置き期限: LocalDate?,
    val 貸出ID: String?
) {
    fun キャンセル() { ... }
    fun 取置き() { ... }
    fun 貸出完了(val 貸出ID: String) {
        if (予約ステータス !== ReservationStatus.取置き) throw UnpredictableError()
        if(this.取置きID == null || this.取置き開始日 == null || this.取り置き期限 == null) throw UnpredictableError()
        if (now.isAfter(this.取置き)) throw BusinessError()
        this.予約ステータス = ReservationStatus.貸出完了
        this.貸出ID = 貸出ID
    }
}
```

### イベントを表現したクラス実装例
各状態を異なるクラスで表現することであり得ないバリデーションは不要になる
```kotlin
class 予約申込(...) { ... }
class 予約キャンセル() { ... }
class 予約取置き(
    val 予約ID: String,
    val 取置きID: String,
    val 取置き開始日: LocalDate,
    val 取置き期限: LocalDate
) {
    fun 貸出完了(val 貸出ID: String): 貸出完了 {
        if (now.isAfter(this.取置き期限)) throw BusinessError()
        return 貸出完了(貸出ID = 貸出ID)
    }
}
class 貸出完了(...) { ... }
```

### クエリに現れる表現の違い
悪い例では取置き状態を取得する際にあり得ない状態の考慮が必要
```sql
SELECT * FROM 予約
WHERE 予約ステータス = '取置き'
AND 取り置きID != NULL AND 取置き開始日 != NULL AND 取置き期限 != NULL
```
良い例ではあり得ない状態をそもそも設計で防ぐ
```sql
-- 現在取置き中のテーブルを用意する場合
SELECT * FROM 取り置き中
-- イベントから現在取り置き中を取り出す場合
SELECT * FROM 予約 INNER JOIN 予約取置き USING (予約ID) 予約ステータス = '取置き'
```

### 業務の複雑さ
仕様把握が困難なほど防御的なNULLチェックを入れたくなる心理
- 予約ステータスが取置きなら取置きIDも普通にNULLにならないでしょ
- 数ヶ月後：様々な仕様変更を得て、人も変わり、取置きステータスなのに取置きIDがNULLのレコードが出来る障害発生
- このクエリのNULLチェックとかの条件判定って全部必要なんですか？
- うーん。正確なことはわからないからNULLで不正な状態になり得るものは全部チェックしておいて。クエリのテストもよろしく。
- ...

### テーブル数は少ないほうがいい？
イベントの数=業務の数=APIやバッチの数

イベントがテーブル設計で表現されたほうが見積もり精度も高い

テーブル数は気にせず、とにかく全体像を表現すること

### とはいえ設計はトレードオフ
記録することに業務上の利用価値があるか

道具として選択肢は持っておき、トレードオフを考えて判断しよう

#### オーバーエンジニアリング
つぶやき
- つぶやきID
- つぶやきステータス

つぶやきイベント
- つぶやきイベントID
- つぶやきID

下書き
- つぶやきイベントID
- つぶやきID
- つぶやき内容

削除
- つぶやきイベントID
- つぶやきID
- 削除時刻

投稿
- つぶやきイベントID
- つぶやきID
- つぶやき内容
- 投稿日時

#### 必要最小限
つぶやき下書き
- つぶやき下書きID
- つぶやき内容

つぶやき
- つぶやきID
- つぶやき内容

### ロングタームイベント
ここまで紹介してきたのはDBの設計パターン

一連のイベントを1つの大きなイベントと捉える設計

出典：イミュータブルデータモデル

利用申請
- 利用申請ID
- 会員種別
- 利用申請ステータス

利用申請イベント
- 利用申請アクティビティID

利用申請提出
- 利用申請イベントID

利用申請承認
- 利用申請イベントID
- 承認管理者ID

利用申請否認
- 利用申請イベントID
- 否認管理者ID
- 否認理由

利用開始
- 利用申請イベントID
- 会員ID
- 担当管理者ID

個人利用申請提出
- 利用申請イベントID
- 氏名
- 生年月日
- 電話番号
- メールアドレス
- 住所
- 利用目的
- 証明書保存先

団体利用申請提出
- 利用申請イベントID
- 団体名
- 団体概要
- 団体電話番号
- 団体メールアドレス
- 団体住所
- 代表者氏名
- 代表者　住所
- 代表者　電話番号
- 代表者　メールアドレス
- 利用目的
- 証明書保存先