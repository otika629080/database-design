# 状態を取り出す設計パターン
1. ステータスカラムのUPDATE
2. 親イベントの全カラムUPDATE
3. 最新状態テーブルのDELETE&INSERT

## 1. ステータスカラムのUPDATE
ロングタームイベント

予約
- 予約ID
- 予約ステータス

予約イベント
- 予約イベントID
- 予約ID

予約申込
- 予約イベントID
- 予約ID
- 会員ID
- 書誌ID
- 予約開始日

予約キャンセル
- 予約イベントID
- 予約ID

予約取置き
- 予約イベントID
- 取置きID
- 取置き開始日
- 取置き期限

```sql
-- 予約中
SELECT * FROM 予約 WHERE 予約ステータス = '予約中'
INNER JOIN 予約申込 USING (予約ID)
-- 全状態の一覧参照
SELECT * FROM 予約
INNER JOIN 予約申込 ON 予約.予約ID = 予約申込.予約ID
LEFT JOIN 予約キャンセル ON 予約.予約ID = 予約キャンセル.予約ID
LEFT JOIN 予約取置き ON 予約.予約ID = 予約取置き.予約ID
```

## 2. 親イベントの全カラムUPDATE
予約
- 予約ID
- 予約ステータス
- 会員ID
- 書誌ID
- 予約開始日
- 予約キャンセル日
- 取り置き開始日
- 取り置き期限

予約イベント
- 予約イベントID
- 予約ID

予約申込
- 予約イベントID
- 予約ID
- 会員ID
- 書誌ID
- 予約開始日

予約キャンセル
- 予約イベントID
- 予約ID
- 予約キャンセル日

予約取置き
- 予約イベントID
- 予約ID
- 取置きID
- 取置き開始日
- 取置き期限

```sql
-- 予約中
SELECT * FROM 予約 WHERE 予約ステータス = '予約中'

-- 全状態の一覧参照
SELECT * FROM 予約
```

## 3. 最新状態のみが入るテーブルを用意
予約
- 予約ID
- 予約ステータス

予約イベント
- 予約イベントID

予約申込中
- 予約イベントID
- 会員ID
- 書誌ID
- 予約開始日

予約キャンセル
- 予約イベントID

予約取り置き
- 予約イベントID
- 取置きID
- 取置き開始日
- 取置き期限

```sql
-- 予約中
SELECT * FROM 予約申込中

-- 全状態の一覧参照
SELECT * FROM 予約申込中
INNER JOIN 予約申込 ON 予約.予約ID = 予約申込.予約ID
LEFT JOIN 予約キャンセル ON 予約.予約ID = 予約キャンセル.予約ID
LEFT JOIN 予約取置き ON 予約.予約ID = 予約取置き.予約ID
```

以下はマークダウン形式で作成した2列4行のテーブルです。

| ユースケース | 設計パターン |
|---|---|
| 異なる状態をまとめて一覧表示したい | 2 > 1 = 3 |
| 特定の状態のみを取得したい | 1 = 3 > 2 |
| 特定の最新状態のみを取得したい | 3 > 1 > 2 |

### 特定の最新状態のみを取得したい事例 従業員の所属と配属
管理者
- 管理者ID

配属
- 管理者ID
- 部門ID
- 配属日

所属
- 管理者ID
- 部門ID
- 配属日

部門
- 部門ID

従業員は複数の部門に所属する(所属状態で表す)

一定期間ごとに異動が発生する(配属イベントで表す)

## テーブル設計　課題
貸出に関わるイベントを整理してロングタームイベントで設計してみよう

''で囲ったのがイベント

ルール抜粋
- '貸出'は貸出中の資料を含めて最大10冊まで
- 予約がない場合に限り、最大2回かつ2週間の'延長'が可能
- '返却'期限を過ぎた場合に返却日から超過日数分の貸出停止処分
- 紛失した資料は貸出を'強制キャンセル'

### 設計例
一括貸出
- 一括貸出ID
- 会員ID

貸出
- 貸出ID
- 貸出ステータス

貸出イベント
- 貸出イベントID

貸出中
- 貸出ID
- 会員ID
- 蔵書ID
- 貸出日
- 貸出期限

貸出開始
- 貸出イベントID
- 会員ID
- 蔵書ID
- 貸出日
- 貸出期限

延長
- 貸出イベントID
- 延長日
- 貸出期限

返却
- 貸出イベントID
- 返却日

強制キャンセル
- 貸出イベントID
- 強制キャンセル理由

#### まとめ
事実(イベント)の記録と状態(ステート)の更新の違いを意識しよう

イベントは大きなイベントと一連のイベントの連なりとして捉えよう

状態の持たせ方は状況に応じてメリット、デメリットを比較して決めよう